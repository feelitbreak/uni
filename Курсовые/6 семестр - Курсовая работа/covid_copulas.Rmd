**Применение копул**

**Кендысь Алексей**

Подключение библиотек
```{r}
library("copula")
library("readxl")
library("summarytools")
library("matrixTests")
library("tseries")
library("TSstudio")
library("VineCopula")
library("rugarch")
```
```{r}
my_log <- function(x) {
  return(log(x / (x - 1)))
}
```

Данные
```{r}
n = 8
my_data <- read_excel("data.xlsx")
ts_plot(my_data)
my_data[,2:(n - 1)] = apply(my_data[,2:(n - 1)], MARGIN = 2, my_log)
my_data[,2:n] = apply(my_data[,2:n], MARGIN = 2, scale)
my_precovid_data <- my_data[my_data$`Дата` < "2020-01-28", ]
my_covid_data <- my_data[my_data$`Дата` >= "2020-01-28", ]
ts_plot(my_precovid_data[,1:(n - 1)])
ts_plot(my_covid_data[,1:(n - 1)])
```

Описательные статистики
```{r}
descr(my_precovid_data, order="p")
descr(my_covid_data, order="p")
```
Тест на нормальность данных
```{r}
col_jarquebera(my_precovid_data[,2:n])
col_jarquebera(my_covid_data[,2:n])
```
Augmented Dickey-Fuller Test, тест на стационарность
```{r}
apply(my_precovid_data[,2:n], MARGIN = 2, adf.test)
apply(my_covid_data[,2:n], MARGIN = 2, adf.test)
```
Phillips-Perron Unit Root Test, тест на стационарность
```{r}
apply(my_precovid_data[,2:n], MARGIN = 2, pp.test)
apply(my_covid_data[,2:n], MARGIN = 2, pp.test)
```
KPSS Test, тест на стационарность
```{r}
apply(my_precovid_data[,2:n], MARGIN = 2, kpss.test)
apply(my_covid_data[,2:n], MARGIN = 2, kpss.test)
```
Pseudo-observations (псевдо-наблюдения?)
```{r}
pseudo_precovid_data = pobs(my_precovid_data[, 2:n])
pseudo_covid_data = pobs(my_covid_data[, 2:n])
```

Kendall plots for pre-covid data (графики Кендалла, данные до коронавируса)
```{r}
for (i in 1:(n-2)) {
  BiCopKPlot(pseudo_precovid_data[, i], pseudo_precovid_data[, (n - 1)])
}
```

Kendall plots for covid data (графики Кендалла, данные во время коронавируса)
```{r}
for (i in 1:(n-2)) {
  BiCopKPlot(pseudo_covid_data[, i], pseudo_covid_data[, (n - 1)])
}
```

GJR-GARCH построение модели
```{r}
spec_gjrGARCH = ugarchspec(variance.model=list(model="gjrGARCH", garchOrder=c(1,1)), mean.model=list(armaOrder=c(0,0), include.mean=FALSE), distribution.model="sstd")

gjrGARCH = c()
for (i in 2:n) {
  gjrGARCH <- append(gjrGARCH, ugarchfit(unlist(my_data[, i]), spec=spec_gjrGARCH))
}
```

Summary of coefficients, значимость коэффициентов
```{r}
for (i in 1:(n - 1)) {
  show((gjrGARCH[[i]])@fit$matcoef)
}
```

Checking the serial correlation and ARCH effects in residuals, the Ljung-Box and ARCH-LM tests
```{r}
for (i in 1:(n - 1)) {
  show(gjrGARCH[[i]])
}
```

Plotting residuals and the corresponding pre-covid data
```{r}
res_precovid = c()
for (i in 1:(n - 1)) {
  res <- as.numeric(residuals(gjrGARCH[[i]], standardize=TRUE))
  res_precovid <- cbind(res_precovid, res[1:nrow(my_precovid_data)])
  plot(my_precovid_data$Дата, res_precovid[, i], type='l', col='red')
  par(new=TRUE)
  plot(my_precovid_data$Дата, unlist(my_precovid_data[, i + 1]), type='l', col='green')
}
```

Plotting residuals and the corresponding covid data
```{r}
res_covid = c()
for (i in 1:(n - 1)) {
  res <- as.numeric(residuals(gjrGARCH[[i]], standardize=TRUE))
  res_covid <- cbind(res_covid, res[(nrow(my_precovid_data) + 1):(nrow(my_precovid_data) + nrow(my_covid_data))])
  plot(my_covid_data$Дата, res_covid[, i], type='l', col='red')
  par(new=TRUE)
  plot(my_covid_data$Дата, unlist(my_covid_data[, i + 1]), type='l', col='green')
}
```

Plotting volatility
```{r}
for (i in 1:(n - 1)) {
  show(plot(sigma(gjrGARCH[[i]])))
}
```

QQ plot уже не знаю зачем
```{r}
for (i in 1:(n - 1)) {
  pit=pit(gjrGARCH[[i]]) 
  hist(pit) # this should be approximately Uniform[0,1]
  norm=qnorm(pit)
  hist(norm) # this should be approximately standard normal
  qqnorm(norm); abline(a=0, b=1) # this is your QQ plot
}
```

*Копулы*

Корреляция Kendall's Tau, до коронавируса
```{r}
for (i in 2:(n - 1)) {
  show(cor(my_precovid_data[, n], my_precovid_data[, i], method = "kendall"))
}
```

Корреляция Kendall's Tau, во время коронавируса
```{r}
for (i in 2:(n - 1)) {
  show(cor(my_covid_data[, n], my_covid_data[, i], method = "kendall"))
}
```

Подбор подходящей копулы, до коронавируса
```{r}
fitted_precovid_copulas = c()

for (i in 1:(n - 2)) {
  fitted_precovid_copulas <- append(fitted_precovid_copulas, BiCopSelect(pseudo_precovid_data[, n - 1], pseudo_precovid_data[, i], familyset = NA))
}

show(fitted_precovid_copulas)
```

Подбор подходящей копулы, после коронавируса
```{r}
fitted_covid_copulas = c()

for (i in 1:(n - 2)) {
  fitted_covid_copulas <- append(fitted_covid_copulas, BiCopSelect(pseudo_covid_data[, n - 1], pseudo_covid_data[, i], familyset = NA))
}

show(fitted_covid_copulas)
```

Goodness-of-fit tests?
```{r}
for (i in 1:(n - 2)) {
  RVineGofTest(pseudo_precovid_data[, c(n - 1, i)],  RVineMatrix(fitted_precovid_copulas[[i]]))
}
```